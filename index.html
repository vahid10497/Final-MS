<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Wall AR export</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    html,body { margin:0; height:100%; background:#111; }
    model-viewer { width:100%; height:100%; display:block; }

    #startOverlay {
      position:fixed; inset:0; display:grid; place-items:center;
      background:rgba(0,0,0,.35); z-index:10; transition:opacity .35s; pointer-events:none;
    }
    #startOverlay.hidden { opacity:0; pointer-events:none; }
    #startImg {
      width:min(92vw,520px); height:auto; opacity:.85;
      border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    #overlayCaption {
      margin-top:10px; color:#fff; text-align:center;
      font:600 16px/1.3 system-ui; text-shadow:0 2px 8px rgba(0,0,0,.5);
    }

    #hint {
      position: fixed; left:50%; bottom:16px; transform:translateX(-50%);
      padding:8px 12px; border-radius:999px; background:rgba(0,0,0,.6); color:#fff;
      font:14px/1.2 system-ui, sans-serif; display:none;
    }
    model-viewer[ar-status="session-started"] + #hint { display:block; }

    #unmute {
      position:fixed; left:50%; top:16px; transform:translateX(-50%);
      padding:8px 12px; border:none; border-radius:999px; background:#fff; display:none;
    }

    #iosMsg {
      position:fixed; left:50%; top:64px; transform:translateX(-50%);
      background:#fff; padding:8px 12px; border-radius:12px; font:14px system-ui;
      display:none; z-index:20; text-align:center; max-width:92vw;
    }
  </style>
</head>
<body>
  <div id="startOverlay">
    <div>
      <img id="startImg" src="./" alt="Start" />
      <div id="overlayCaption">Point your phone at this image, then <b>tap a wall</b> to place.</div>
    </div>
  </div>

  <model-viewer id="mv"
    src="./PortalANimMusAgustFinal_1.glb"
    ar
    ar-modes="webxr quick-look"
    
    ar-placement="wall"
    xr-hit-test="transient-input"
    ar-scale="fixed"
    xr-environment
    camera-controls
    interaction-prompt="none"
    environment-image="neutral"
    exposure="1"
    style="width:100%; height:100%;">
    <button id="arBtn" slot="ar-button"
      style="position:absolute; right:16px; bottom:16px; padding:10px 14px; border-radius:999px; border:none; background:#fff;">
      View in AR
    </button>
  </model-viewer>

  <div id="hint">Move your phone to find a wall, then tap to place.</div>

  <div id="iosMsg">On iPhone, AR Quick Look requires a USDZ. This demo will open inline 3D if no USDZ is present.</div>

  <button id="unmute">Tap to enable audio</button>
  <audio id="bg" src="./" loop preload="auto"></audio>

  <script>
    const mv = document.getElementById('mv');
    const arBtn = document.getElementById('arBtn');
    const startOverlay = document.getElementById('startOverlay');
    const bg = document.getElementById('bg');
    const unmute = document.getElementById('unmute');
    const iosMsg = document.getElementById('iosMsg');

    let audioUnlocked = false;
    let placed = false;

    const isiOS = /iP(hone|ad|od)/.test(navigator.userAgent);
    const hasUSDZ = false;
    if (isiOS && !hasUSDZ) iosMsg.style.display = 'block';

    if (isiOS) {
      mv.setAttribute('ar-modes', hasUSDZ ? 'quick-look' : 'webxr');
    } else {
      mv.setAttribute('ar-modes', 'webxr');
      mv.setAttribute('ar-placement', 'wall');
      mv.setAttribute('xr-hit-test', 'transient-input');
    }

    async function unlockAudioOnce() {
      if (audioUnlocked) return;
      try { await bg.play(); bg.pause(); audioUnlocked = true; unmute.style.display = 'none'; }
      catch { unmute.style.display = 'block'; }
    }
    document.addEventListener('pointerdown', unlockAudioOnce, { once: true });
    arBtn.addEventListener('click', unlockAudioOnce);
    unmute.addEventListener('click', async () => { try { await bg.play(); audioUnlocked = true; unmute.style.display = 'none'; } catch {} });

    mv.addEventListener('ar-status', (e) => {
      const status = e.detail.status;
      if (status !== 'session-started') { bg.pause(); placed = false; startOverlay.classList.remove('hidden'); }
    });

    mv.addEventListener('ar-placement', async () => {
      if (placed) return;
      placed = true;
      startOverlay.classList.add('hidden');
      if (!isiOS && bg.paused) { try { await bg.play(); } catch {} }
    });

    mv.addEventListener('quick-look-button-tapped', () => { startOverlay.classList.add('hidden'); });
  </script>
</body>
</html>
