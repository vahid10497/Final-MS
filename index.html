<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Wall AR â€“ Tap to Place + Start Image + Audio</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    html,body { margin:0; height:100%; background:#111; }
    model-viewer { width:100%; height:100%; display:block; }
    #startOverlay { position: fixed; inset: 0; display:grid; place-items:center; background:rgba(0,0,0,.35); z-index:10; transition: opacity .35s; }
    #startOverlay.hidden { opacity:0; pointer-events:none; }
    #startImg { max-width:min(90vw,520px); width:90vw; opacity:.85; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    #overlayCaption { margin-top:10px; text-align:center; color:#fff; font:600 16px/1.3 system-ui; text-shadow:0 2px 8px rgba(0,0,0,.5); }
    #hint { position: fixed; left:50%; bottom:16px; transform:translateX(-50%); padding:8px 12px; border-radius:999px; background:rgba(0,0,0,.6); color:#fff; font:14px/1.2 system-ui; display:none; z-index:5; }
    model-viewer[ar-status="session-started"] ~ #hint { display:block; }
    #unmute { position:fixed; left:50%; top:16px; transform:translateX(-50%); padding:8px 12px; border:none; border-radius:999px; background:#fff; z-index:15; display:none; }
    #status { position:fixed; left:50%; top:16px; transform:translateX(-50%); background:#fff; padding:10px 14px; border-radius:12px; font:14px system-ui; display:none; z-index:20; text-align:center; max-width:90vw; }
  </style>
</head>
<body>
  <model-viewer id="mv"
    src="./PortalANimMus-02.glb"
    ios-src="./PortalANimMus-02.usdz"     <!-- add a USDZ to allow iOS fallback -->
    ar
    ar-modes="webxr quick-look"           <!-- try WebXR first; fallback to Quick Look -->
    ar-placement="wall"                    <!-- wall placement when WebXR runs -->
    ar-scale="fixed"
    xr-environment
    camera-controls
    interaction-prompt="none"
    environment-image="neutral"
    exposure="1">
    <button id="arBtn" slot="ar-button"
      style="position:absolute; right:16px; bottom:16px; padding:10px 14px; border-radius:999px; border:none; background:#fff;">
      View in AR
    </button>
  </model-viewer>

  <div id="startOverlay">
    <div>
      <img id="startImg" src="./StartImage.png" alt="Start Marker" />
      <div id="overlayCaption">Point your phone at this image and tap on the wall to place.</div>
    </div>
  </div>

  <div id="hint">Move your phone to find a wall, then tap to place.</div>
  <div id="status"></div>

  <audio id="bg" src="./museumversion_250709.mp3" loop preload="auto"></audio>
  <button id="unmute">Tap to enable audio</button>

  <script>
    const mv = document.getElementById('mv');
    const arBtn = document.getElementById('arBtn');
    const startOverlay = document.getElementById('startOverlay');
    const hint = document.getElementById('hint');
    const bg = document.getElementById('bg');
    const unmute = document.getElementById('unmute');
    const statusBox = document.getElementById('status');

    let audioUnlocked = false;
    let placed = false;

    function showStatus(msg) {
      statusBox.textContent = msg;
      statusBox.style.display = 'block';
      setTimeout(() => statusBox.style.display = 'none', 5000);
    }

    // Basic capability checks with helpful messages
    (async () => {
      if (!window.isSecureContext) showStatus('This page must be served over HTTPS.');
      if (!('xr' in navigator)) showStatus('WebXR not detected. On iPhone, open in Safari (iOS 17+).');
      else {
        try {
          const ok = await navigator.xr.isSessionSupported('immersive-ar');
          if (!ok) showStatus('WebXR AR not supported on this device/browser.');
        } catch (e) { showStatus('WebXR check failed. Try Safari on iOS 17+ or Chrome on Android.'); }
      }
    })();

    // Audio unlock
    async function tryUnlockAudio() {
      if (audioUnlocked) return;
      try { await bg.play(); bg.pause(); audioUnlocked = true; unmute.style.display = 'none'; }
      catch { unmute.style.display = 'block'; }
    }
    document.addEventListener('pointerdown', tryUnlockAudio, { once: true });
    arBtn.addEventListener('click', tryUnlockAudio);
    unmute.addEventListener('click', async () => {
      try { await bg.play(); audioUnlocked = true; unmute.style.display = 'none'; } catch {}
    });

    // AR lifecycle and errors
    mv.addEventListener('ar-status', (e) => {
      const { status, reason } = e.detail; // not-presenting | session-started | failed
      if (status === 'session-started') {
        hint.style.display = 'block';
        // don't hide start overlay until placement
        if (audioUnlocked) bg.play().catch(()=>{});
      } else if (status === 'failed') {
        showStatus('Could not start AR: ' + (reason || 'Unknown. Open in Safari (iOS) or Chrome (Android).'));
      } else {
        bg.pause();
      }
    });

    // Start only after user tap placement
    mv.addEventListener('ar-placement', async () => {
      if (placed) return;
      placed = true;
      startOverlay.classList.add('hidden');
      hint.style.display = 'none';

      try {
        const anims = mv.availableAnimations || [];
        if (anims.length) mv.animationName = anims[0];
        mv.play({ repetitions: Infinity });
      } catch {}
      try { await bg.play(); } catch {}
    });
  </script>
</body>
</html>
