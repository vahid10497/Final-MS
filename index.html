<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Wall AR â€“ Tap to Place</title>
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
<style>
  html,body{margin:0;height:100%;background:#111}
  model-viewer{width:100%;height:100%;display:block}
  /* Start overlay */
  #startOverlay{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.35);z-index:10;transition:opacity .35s}
  #startOverlay.hidden{opacity:0;pointer-events:none}
  #startImg{max-width:min(90vw,520px);width:90vw;opacity:.85;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  #overlayCaption{margin-top:10px;text-align:center;color:#fff;font:600 16px/1.3 system-ui;text-shadow:0 2px 8px rgba(0,0,0,.5)}
  /* Always-visible AR button */
  #startAR{position:fixed;right:16px;bottom:16px;z-index:20;padding:10px 14px;border:none;border-radius:999px;background:#fff;font:600 14px system-ui}
  /* Hint + status */
  #hint{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);padding:8px 12px;border-radius:999px;background:rgba(0,0,0,.6);color:#fff;font:14px system-ui;display:none;z-index:5}
  model-viewer[ar-status="session-started"] ~ #hint{display:block}
  #status{position:fixed;left:50%;top:16px;transform:translateX(-50%);background:#fff;padding:10px 14px;border-radius:12px;font:14px system-ui;display:none;z-index:30;max-width:90vw;text-align:center}
  #unmute{position:fixed;left:50%;top:64px;transform:translateX(-50%);padding:8px 12px;border:none;border-radius:999px;background:#fff;z-index:30;display:none}
</style>
</head>
<body>
  <model-viewer id="mv"
    src="./PortalANimMus-02.glb"
    ios-src="./PortalANimMus-02.usdz"            <!-- add this file later; button works either way -->
    ar
    ar-modes="webxr quick-look"
    ar-placement="wall"                           <!-- wall anchoring when WebXR runs -->
    ar-scale="fixed"
    xr-environment
    camera-controls
    interaction-prompt="none"
    environment-image="neutral"
    exposure="1">
  </model-viewer>

  <!-- Always-visible Start AR button -->
  <button id="startAR">View in AR</button>

  <!-- Instruction overlay until first placement -->
  <div id="startOverlay">
    <div>
      <img id="startImg" src="./StartImage.png" alt="Start Marker" />
      <div id="overlayCaption">Point your phone at this image and tap on the wall to place.</div>
    </div>
  </div>

  <div id="hint">Move your phone to find a wall, then tap to place.</div>
  <div id="status"></div>

  <audio id="bg" src="./museumversion_250709.mp3" loop preload="auto"></audio>
  <button id="unmute">Tap to enable audio</button>

<script>
const mv = document.getElementById('mv');
const startAR = document.getElementById('startAR');
const startOverlay = document.getElementById('startOverlay');
const hint = document.getElementById('hint');
const statusBox = document.getElementById('status');
const bg = document.getElementById('bg');
const unmute = document.getElementById('unmute');

let audioUnlocked = false;
let placed = false;

function status(msg){ statusBox.textContent = msg; statusBox.style.display='block'; setTimeout(()=>statusBox.style.display='none', 5000); }

// Unlock audio on first gesture
async function unlockAudio(){
  if (audioUnlocked) return;
  try { await bg.play(); bg.pause(); audioUnlocked = true; unmute.style.display='none'; }
  catch { unmute.style.display='block'; }
}
document.addEventListener('pointerdown', unlockAudio, { once:true });
unmute.addEventListener('click', async ()=>{ try{ await bg.play(); audioUnlocked = true; unmute.style.display='none'; }catch{} });

// Start AR when the visible button is pressed
startAR.addEventListener('click', async ()=>{
  await unlockAudio();
  try {
    await mv.activateAR();         // works even if the stock AR button is hidden
  } catch (e) {
    status('Could not start AR: ' + (e?.message || e || 'Open in Safari (iOS 17+) or Chrome (Android).'));
  }
});

// AR lifecycle
mv.addEventListener('ar-status', async (e)=>{
  const {status:st, reason} = e.detail || {};
  if (st === 'session-started'){
    if (audioUnlocked) bg.play().catch(()=>{});
    hint.style.display = 'block';
  } else if (st === 'failed'){
    status('AR failed: ' + (reason || 'Unknown. If on iPhone, ensure Safari + iOS 17+.'));
  } else {
    bg.pause();
  }
});

// Only after explicit tap-to-place
mv.addEventListener('ar-placement', async ()=>{
  if (placed) return;
  placed = true;
  startOverlay.classList.add('hidden');
  hint.style.display = 'none';

  try {
    const anims = mv.availableAnimations || [];
    if (anims.length) mv.animationName = anims[0];
    mv.play({ repetitions: Infinity });
  } catch {}

  try { await bg.play(); } catch {}
});
</script>
</body>
</html>
